

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Installation Environments &mdash; Singularity container 2.6 documentation</title>




    <link rel="shortcut icon" href="_static/favicon.ico"/>












  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Appendix" href="appendix.html" />
    <link rel="prev" title="Troubleshooting" href="troubleshooting.html" />


  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">


  <div class="wy-grid-for-nav">


    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">



            <a href="index.html" class="icon icon-home"> Singularity container




            <img src="_static/logo.png" class="logo" alt="Logo"/>

          </a>




              <div class="version">
                2.6
              </div>




<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">






              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="admin_quickstart.html">Administration Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="the_singularity_config_file.html">The Singularity Config File</a></li>
<li class="toctree-l1"><a class="reference internal" href="container_checks.html">Container Checks</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation Environments</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#singularity-on-hpc">Singularity on HPC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#workflows">Workflows</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#integration-with-mpi">Integration with MPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tutorials">Tutorials</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mpi-development-example">MPI Development Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-example-using-open-mpi-2-1-0-stable">Code Example using Open MPI 2.1.0 Stable</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-example-using-open-mpi-git-master">Code Example using Open MPI git master</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#image-environment">Image Environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#directory-access">Directory access</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#current-working-directory">Current Working Directory</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#standard-io-and-pipes">Standard IO and pipes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#containing-the-container">Containing the container</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#license">License</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#in-layman-terms">In layman terms…</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>



        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">


      <nav class="wy-nav-top" aria-label="top navigation">

          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Singularity container</a>

      </nav>


      <div class="wy-nav-content">

        <div class="rst-content style-external-links">

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">

      <li><a href="index.html">Docs</a> &raquo;</li>

      <li>Installation Environments</li>


      <li class="wy-breadcrumbs-aside">



              <a href="https://github.com/sylabs/singularity-admindocs/blob/master/installation_environments.rst" class="fa fa-github"> Edit on GitHub</a>



      </li>

  </ul>


  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <div class="section" id="installation-environments">
<h1>Installation Environments<a class="headerlink" href="#installation-environments" title="Permalink to this headline">¶</a></h1>
<div class="section" id="singularity-on-hpc">
<h2>Singularity on HPC<a class="headerlink" href="#singularity-on-hpc" title="Permalink to this headline">¶</a></h2>
<p>One of the architecturally defined features in Singularity is that it
can execute containers like they are native programs or scripts on a
host computer. As a result, integration with schedulers is simple and
runs exactly as you would expect. All standard input, output, error,
pipes, IPC, and other communication pathways that locally running
programs employ are synchronized with the applications running locally
within the container.
Additionally, because Singularity is not emulating a full hardware
level virtualization paradigm, there is no need to separate out any
sandboxed networks or file systems because there is no concept of
user-escalation within a container. Users can run Singularity
containers just as they run any other program on the HPC resource.</p>
<div class="section" id="workflows">
<h3>Workflows<a class="headerlink" href="#workflows" title="Permalink to this headline">¶</a></h3>
<p>We are in the process of developing Singularity Hub, which will allow
for generation of workflows using Singularity containers in an online
interface, and easy deployment on standard research clusters (e.g.,
SLURM, SGE). Currently, the Singularity core software is installed on
the following research clusters, meaning you can run Singularity
containers as part of your jobs:</p>
<ul class="simple">
<li>The <a class="reference external" href="http://sherlock.stanford.edu/">Sherlock cluster</a> at <a class="reference external" href="https://srcc.stanford.edu/">Stanford
University</a></li>
<li><a class="reference external" href="https://www.xsede.org/news/-/news/item/7624">SDSC Comet and
Gordon</a> (XSEDE)</li>
<li><a class="reference external" href="http://docs.massive.org.au/index.html">MASSIVE M1 M2 and M3</a>
(Monash University and Australian National Merit Allocation Scheme)</li>
</ul>
<div class="section" id="integration-with-mpi">
<h4>Integration with MPI<a class="headerlink" href="#integration-with-mpi" title="Permalink to this headline">¶</a></h4>
<p>Another result of the Singularity architecture is the ability to
properly integrate with the Message Passing Interface (MPI). Work has
already been done for out of the box compatibility with Open MPI (both
in Open MPI v2.1.x as well as part of Singularity). The Open
MPI/Singularity workflow works as follows:</p>
<ol class="arabic simple">
<li>mpirun is called by the resource manager or the user directly from a
shell</li>
<li>Open MPI then calls the process management daemon (ORTED)</li>
<li>The ORTED process launches the Singularity container requested by the
mpirun command</li>
<li>Singularity builds the container and namespace environment</li>
<li>Singularity then launches the MPI application within the container</li>
<li>The MPI application launches and loads the Open MPI libraries</li>
<li>The Open MPI libraries connect back to the ORTED process via the
Process Management Interface (PMI)</li>
<li>At this point the processes within the container run as they would
normally directly on the host.</li>
</ol>
<p>This entire process happens behind the scenes, and from the user’s
perspective running via MPI is as simple as just calling mpirun on the
host as they would normally.
Below are example snippets of building and installing OpenMPI into a
container and then running an example MPI program through Singularity.</p>
</div>
<div class="section" id="tutorials">
<h4>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h4>
<p><a class="reference internal" href="appendix.html#using-host-libraries-gpu-drivers-and-openmpi-btls"><span class="std std-ref">Using Host libraries: GPU drivers and OpenMPI BTLs</span></a></p>
</div>
<div class="section" id="mpi-development-example">
<h4>MPI Development Example<a class="headerlink" href="#mpi-development-example" title="Permalink to this headline">¶</a></h4>
<p><strong>What are supported Open MPI Version(s)?</strong> To achieve proper
container’ized Open MPI support, you should use Open MPI version 2.1.
There are however three caveats:</p>
<ol class="arabic simple">
<li>Open MPI 1.10.x may work but we expect you will need exactly matching
version of PMI and Open MPI on both host and container (the 2.1
series should relax this requirement)</li>
<li>Open MPI 2.1.0 has a bug affecting compilation of libraries for some
interfaces (particularly Mellanox interfaces using libmxm are known
to fail). If your in this situation you should use the master branch
of Open MPI rather than the release.</li>
<li>Using Open MPI 2.1 does not magically allow your container to connect
to networking fabric libraries in the host. If your cluster has, for
example, an infiniband network you still need to install OFED
libraries into the container. Alternatively you could bind mount both
Open MPI and networking libraries into the container, but this could
run afoul of glib compatibility issues (its generally OK if the
container glibc is more recent than the host, but not the other way
around)</li>
</ol>
</div>
<div class="section" id="code-example-using-open-mpi-2-1-0-stable">
<h4>Code Example using Open MPI 2.1.0 Stable<a class="headerlink" href="#code-example-using-open-mpi-2-1-0-stable" title="Permalink to this headline">¶</a></h4>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ # Include the appropriate development tools into the container (notice we are calling

$ # singularity as root and the container is writable)

$ sudo singularity exec -w /tmp/Centos-7.img yum groupinstall &quot;Development Tools&quot;

$

$ # Obtain the development version of Open MPI

$ wget https://www.open-mpi.org/software/ompi/v2.1/downloads/openmpi-2.1.0.tar.bz2

$ tar jtf openmpi-2.1.0.tar.bz2

$ cd openmpi-2.1.0

$

$ singularity exec /tmp/Centos-7.img ./configure --prefix=/usr/local

$ singularity exec /tmp/Centos-7.img make

$

$ # Install OpenMPI into the container (notice now running as root and container is writable)

$ sudo singularity exec -w -B /home /tmp/Centos-7.img make install

$

$ # Build the OpenMPI ring example and place the binary in this directory

$ singularity exec /tmp/Centos-7.img mpicc examples/ring_c.c -o ring

$

$ # Install the MPI binary into the container at /usr/bin/ring

$ sudo singularity copy /tmp/Centos-7.img ./ring /usr/bin/

$

$ # Run the MPI program within the container by calling the MPIRUN on the host

$ mpirun -np 20 singularity exec /tmp/Centos-7.img /usr/bin/ring
</pre></div>
</div>
</div>
<div class="section" id="code-example-using-open-mpi-git-master">
<h4>Code Example using Open MPI git master<a class="headerlink" href="#code-example-using-open-mpi-git-master" title="Permalink to this headline">¶</a></h4>
<p>The previous example (using the Open MPI 2.1.0 stable release) should
work fine on most hardware but if you have an issue, try running the
example below (using the Open MPI Master branch):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ # Include the appropriate development tools into the container (notice we are calling

$ # singularity as root and the container is writable)

$ sudo singularity exec -w /tmp/Centos-7.img yum groupinstall &quot;Development Tools&quot;

$

$ # Clone the OpenMPI GitHub master branch in current directory (on host)

$ git clone https://github.com/open-mpi/ompi.git

$ cd ompi

$

$ # Build OpenMPI in the working directory, using the tool chain within the container

$ singularity exec /tmp/Centos-7.img ./autogen.pl

$ singularity exec /tmp/Centos-7.img ./configure --prefix=/usr/local

$ singularity exec /tmp/Centos-7.img make

$

$ # Install OpenMPI into the container (notice now running as root and container is writable)

$ sudo singularity exec -w -B /home /tmp/Centos-7.img make install

$

$ # Build the OpenMPI ring example and place the binary in this directory

$ singularity exec /tmp/Centos-7.img mpicc examples/ring_c.c -o ring

$

$ # Install the MPI binary into the container at /usr/bin/ring

$ sudo singularity copy /tmp/Centos-7.img ./ring /usr/bin/

$

$ # Run the MPI program within the container by calling the MPIRUN on the host

$ mpirun -np 20 singularity exec /tmp/Centos-7.img /usr/bin/ring



Process 0 sending 10 to 1, tag 201 (20 processes in ring)

Process 0 sent to 1

Process 0 decremented value: 9

Process 0 decremented value: 8

Process 0 decremented value: 7

Process 0 decremented value: 6

Process 0 decremented value: 5

Process 0 decremented value: 4

Process 0 decremented value: 3

Process 0 decremented value: 2

Process 0 decremented value: 1

Process 0 decremented value: 0

Process 0 exiting

Process 1 exiting

Process 2 exiting

Process 3 exiting

Process 4 exiting

Process 5 exiting

Process 6 exiting

Process 7 exiting

Process 8 exiting

Process 9 exiting

Process 10 exiting

Process 11 exiting

Process 12 exiting

Process 13 exiting

Process 14 exiting

Process 15 exiting

Process 16 exiting

Process 17 exiting

Process 18 exiting

Process 19 exiting
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="image-environment">
<h2>Image Environment<a class="headerlink" href="#image-environment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="directory-access">
<h3>Directory access<a class="headerlink" href="#directory-access" title="Permalink to this headline">¶</a></h3>
<p>By default Singularity tries to create a seamless user experience
between the host and the container. To do this, Singularity makes
various locations accessible within the container automatically. For
example, the user’s home directory is always bound into the container as
is /tmp and /var/tmp. Additionally your current working directory
(cwd/pwd) is also bound into the container iff it is not an operating
system directory or already accessible via another mount. For almost all
cases, this will work flawlessly as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ pwd

/home/gmk/demo

$ singularity shell container.img

Singularity/container.img&gt; pwd

/home/gmk/demo

Singularity/container.img&gt; ls -l debian.def

-rw-rw-r--. 1 gmk gmk 125 May 28 10:35 debian.def

Singularity/container.img&gt; exit

$
</pre></div>
</div>
<p>For directory binds to function properly, there must be an existing
target endpoint within the container (just like a mount point). This
means that if your home directory exists in a non-standard base
directory like “/foobar/username” then the base directory “/foobar”
must already exist within the container.
Singularity will not create these base directories! You must enter the
container with the option <code class="docutils literal notranslate"><span class="pre">--writable</span></code> being set, and create the directory
manually.</p>
<div class="section" id="current-working-directory">
<h4>Current Working Directory<a class="headerlink" href="#current-working-directory" title="Permalink to this headline">¶</a></h4>
<p>Singularity will try to replicate your current working directory within
the container. Sometimes this is straight forward and possible, other
times it is not (e.g. if the base dir of your current working directory
does not exist). In that case, Singularity will retain the file
descriptor to your current directory and change you back to it. If you
do a ‘pwd’ within the container, you may see some weird things. For
example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ pwd

/foobar

$ ls -l

total 0

-rw-r--r--. 1 root root 0 Jun  1 11:32 mooooo

$ singularity shell ~/demo/container.img

WARNING: CWD bind directory not present: /foobar

Singularity/container.img&gt; pwd

(unreachable)/foobar

Singularity/container.img&gt; ls -l

total 0

-rw-r--r--. 1 root root 0 Jun  1 18:32 mooooo

Singularity/container.img&gt; exit

$
</pre></div>
</div>
<p>But notice how even though the directory location is not resolvable, the
directory contents are available.</p>
</div>
</div>
<div class="section" id="standard-io-and-pipes">
<h3>Standard IO and pipes<a class="headerlink" href="#standard-io-and-pipes" title="Permalink to this headline">¶</a></h3>
<p>Singularity automatically sends and receives all standard IO from the
host to the applications within the container to facilitate expected
behavior from the interaction between the host and the container. For
example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cat debian.def | singularity exec container.img grep &#39;MirrorURL&#39;

MirrorURL &quot;http://ftp.us.debian.org/debian/&quot;

$

Making changes to the container (writable)

By default, containers are accessed as read only. This is both to enable parallel container execution (e.g. MPI). To enter a container using exec, run, or shell you must pass the --writable flag in order to open the image as read/writable.
</pre></div>
</div>
</div>
<div class="section" id="containing-the-container">
<h3>Containing the container<a class="headerlink" href="#containing-the-container" title="Permalink to this headline">¶</a></h3>
<p>By providing the argument <code class="docutils literal notranslate"><span class="pre">--contain</span></code> to <code class="docutils literal notranslate"><span class="pre">exec</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code> or <code class="docutils literal notranslate"><span class="pre">shell</span></code> you will find that shared directories
are no longer shared. For example, the user’s home directory is
writable, but it is non-persistent between non-overlapping runs.</p>
</div>
</div>
<div class="section" id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Redistribution and use in source and binary forms, with or without

modification, are permitted provided that the following conditions are met:


(1) Redistributions of source code must retain the above copyright notice,

this list of conditions and the following disclaimer.


(2) Redistributions in binary form must reproduce the above copyright notice,

this list of conditions and the following disclaimer in the documentation

and/or other materials provided with the distribution.


(3) Neither the name of the University of California, Lawrence Berkeley

National Laboratory, U.S. Dept. of Energy nor the names of its contributors

may be used to endorse or promote products derived from this software without

specific prior written permission.


THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;

AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE

IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE

DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE

FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL

DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR

SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER

CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,

OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE

OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.


You are under no obligation whatsoever to provide any bug fixes, patches, or

upgrades to the features, functionality or performance of the source code

(&quot;Enhancements&quot;) to anyone; however, if you choose to make your Enhancements

available either publicly, or directly to Lawrence Berkeley National

Laboratory, without imposing a separate written license agreement for such

Enhancements, then you hereby grant the following license: a  non-exclusive,

royalty-free perpetual license to install, use, modify, prepare derivative

works, incorporate into other computer software, distribute, and sublicense

such enhancements or derivative works thereof, in binary and source code form.


If you have questions about your rights to use or distribute this software,

please contact Berkeley Lab&#39;s Innovation &amp; Partnerships Office at

IPO@lbl.gov.


NOTICE.  This Software was developed under funding from the U.S. Department of

Energy and the U.S. Government consequently retains certain rights. As such,

the U.S. Government has been granted for itself and others acting on its

behalf a paid-up, nonexclusive, irrevocable, worldwide license in the Software

to reproduce, distribute copies to the public, prepare derivative works, and

perform publicly and display publicly, and to permit other to do so.
</pre></div>
</div>
<div class="section" id="in-layman-terms">
<h3>In layman terms…<a class="headerlink" href="#in-layman-terms" title="Permalink to this headline">¶</a></h3>
<p>In addition to the (already widely used and very free open source)
standard BSD 3 clause license, there is also wording specific to
contributors which ensures that we have permission to release,
distribute and include a particular contribution, enhancement, or fix as
part of Singularity proper. For example any contributions submitted will
have the standard BSD 3 clause terms (unless specifically and otherwise
stated) and that the contribution is comprised of original new code that
the contributor has authority to contribute.</p>
</div>
</div>
</div>


           </div>

          </div>
          <footer>

    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">

        <a href="appendix.html" class="btn btn-neutral float-right" title="Appendix" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>


        <a href="troubleshooting.html" class="btn btn-neutral" title="Troubleshooting" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>

    </div>


  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Singularity.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>



  <script type="text/javascript" src="_static/js/footer.js"></script>

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.6.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>



  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
